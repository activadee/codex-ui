name: Manual Release

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag to create (e.g. v0.1.0)"
        required: true
      release_title:
        description: "Display name (defaults to tag)"
        required: false
      target:
        description: "Commit/branch to release"
        default: "main"
        required: true
      draft:
        description: "Create as a draft release"
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.artifact_suffix }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux/amd64
            artifact_suffix: linux-amd64
          - os: macos-latest
            platform: darwin/arm64
            artifact_suffix: macos-arm64
          - os: windows-latest
            platform: windows/amd64
            artifact_suffix: windows-amd64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ inputs.target }}

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev
          npm ci
        working-directory: frontend

      - name: Run tests
        if: matrix.os == 'ubuntu-latest'
        run: go test ./...

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Build application
        run: wails build -clean -platform ${{ matrix.platform }}
        env:
          CGO_ENABLED: "1"

      - name: Package Linux artifact
        if: matrix.os == 'ubuntu-latest'
        run: |
          tar -czf codex-ui-${{ matrix.artifact_suffix }}.tar.gz -C build/bin codex-ui

      - name: Package macOS artifact
        if: matrix.os == 'macos-latest'
        run: |
          ditto -c -k --keepParent "build/bin/codex-ui.app" "codex-ui-${{ matrix.artifact_suffix }}.zip"

      - name: Package Windows artifact
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Compress-Archive -Path "build\bin\codex-ui.exe" -DestinationPath "codex-ui-${{ matrix.artifact_suffix }}.zip"

      - name: Upload Linux artifact
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v5
        with:
          name: codex-ui-${{ matrix.artifact_suffix }}
          path: codex-ui-${{ matrix.artifact_suffix }}.tar.gz

      - name: Upload macOS artifact
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v5
        with:
          name: codex-ui-${{ matrix.artifact_suffix }}
          path: codex-ui-${{ matrix.artifact_suffix }}.zip

      - name: Upload Windows artifact
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v5
        with:
          name: codex-ui-${{ matrix.artifact_suffix }}
          path: codex-ui-${{ matrix.artifact_suffix }}.zip

  publish:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ inputs.target }}

      - name: Determine previous tag
        id: prev_tag
        run: |
          git fetch --tags --quiet
          LAST_TAG=$(git describe --tags --abbrev=0 --match "v*" 2>/dev/null || echo "")
          echo "value=$LAST_TAG" >> "$GITHUB_OUTPUT"

      - name: Build Codex prompt
        id: prompt
        run: |
          TAG_NAME="${{ inputs.tag_name }}"
          LAST_TAG="${{ steps.prev_tag.outputs.value }}"
          if [ -z "$LAST_TAG" ]; then
            RANGE_DESC="project start"
            COMMITS=$(git log --pretty=format:'- %s (%h)' --no-merges)
          else
            RANGE_DESC="${LAST_TAG}..${GITHUB_SHA}"
            COMMITS=$(git log --pretty=format:'- %s (%h)' --no-merges "${LAST_TAG}..${GITHUB_SHA}")
          fi

          if [ -z "$COMMITS" ]; then
            COMMITS="- No new commits detected."
          fi

          TEMPLATE=$(cat .github/prompts/codex-release-template.md)

          cat <<EOF > codex_prompt.md
          ${TEMPLATE}

          Release tag: ${TAG_NAME}
          Commit range: ${RANGE_DESC}

          Commits:
          ${COMMITS}
          EOF

      - name: Load release schema
        run: echo "CODEX_OUTPUT_SCHEMA=$(jq -c . .github/prompts/codex-release-schema.json)" >> "$GITHUB_ENV"

      - name: Generate release highlights with Codex
        uses: activadee/codex-action@main
        with:
          codex-auth-json-b64: ${{ secrets.CODEX_AUTH_JSON_B64 }}
          prompt-file: codex_prompt.md
          output-file: codex-release.json
          output-schema: ${{ env.CODEX_OUTPUT_SCHEMA }}
          safety-strategy: drop-sudo

      - name: Render release notes
        id: render
        run: |
          SUMMARY=$(jq -r '.overview // empty' codex-release.json)
          {
            if [ -n "$SUMMARY" ]; then
              echo "$SUMMARY"
              echo
            fi
            jq -r '.highlights[] | "- " + .' codex-release.json
          } > release-notes.md
          {
            echo "notes<<EOF"
            cat release-notes.md
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Download build artifacts
        uses: actions/download-artifact@v6
        with:
          path: dist

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.tag_name }}
          target_commitish: ${{ inputs.target }}
          name: ${{ inputs.release_title || inputs.tag_name }}
          draft: ${{ inputs.draft }}
          body_path: release-notes.md
          files: |
            dist/**/*.tar.gz
            dist/**/*.zip
