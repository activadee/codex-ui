name: Manual Release

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag to create (e.g. v0.1.0)"
        required: true
      release_title:
        description: "Display name (defaults to tag)"
        required: false
      target:
        description: "Commit/branch to release"
        default: "main"
        required: true
      draft:
        description: "Create as a draft release"
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.artifact_suffix }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux/amd64
            artifact_suffix: linux-amd64
          - os: macos-latest
            platform: darwin/arm64
            artifact_suffix: macos-arm64
          - os: windows-latest
            platform: windows/amd64
            artifact_suffix: windows-amd64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ inputs.target }}

      - name: Build application
        uses: dAppServer/wails-build-action@main
        env:
          CGO_ENABLED: "1"
        with:
          app-working-directory: .
          build-name: codex-ui
          build-platform: ${{ matrix.platform }}
          go-version: "1.25.3"
          node-version: "22"
          package: false
          build-obfuscate: true
          wails-version: "v2.10.2"

      - name: Package Linux artifact
        if: matrix.os == 'ubuntu-latest'
        run: |
          tar -czf codex-ui-${{ matrix.artifact_suffix }}.tar.gz -C build/bin codex-ui

      - name: Package macOS artifact
        if: matrix.os == 'macos-latest'
        run: |
          ditto -c -k --keepParent "build/bin/codex-ui.app" "codex-ui-${{ matrix.artifact_suffix }}.zip"

      - name: Package Windows artifact
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Compress-Archive -Path "build\bin\codex-ui" -DestinationPath "codex-ui-${{ matrix.artifact_suffix }}.zip"

      - name: Upload Linux artifact
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v5
        with:
          name: codex-ui-${{ matrix.artifact_suffix }}
          path: codex-ui-${{ matrix.artifact_suffix }}.tar.gz

      - name: Upload macOS artifact
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v5
        with:
          name: codex-ui-${{ matrix.artifact_suffix }}
          path: codex-ui-${{ matrix.artifact_suffix }}.zip

      - name: Upload Windows artifact
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v5
        with:
          name: codex-ui-${{ matrix.artifact_suffix }}
          path: codex-ui-${{ matrix.artifact_suffix }}.zip

  publish:
    needs: build
    uses: activadee/codex-shared-workflows/workflows/release.yml@main
    secrets: inherit
    with:
      tag_name: ${{ inputs.tag_name }}
      release_title: ${{ inputs.release_title }}
      target: ${{ inputs.target }}
      draft: ${{ inputs.draft }}
      run_tests: false
      download_artifacts: true
      artifacts_path: dist
      artifact_glob: |
        dist/**/*.tar.gz
        dist/**/*.zip
